name: Update Git submodules

on:
  repository_dispatch:
    types:
      - platform-frontend-update
      - landing-frontend-update
      - backend-update
      - admin-frontend-update

jobs:
  update-submodule:
    runs-on: ubuntu-latest

    steps:
      # Клонируем репозиторий вместе с субмодулями
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      # Настраиваем автора-коммиттера
      - name: Configure Git
        run: |
          git config --global user.name  'GitHub Actions'
          git config --global user.email 'actions@github.com'

      # Определяем, какой субмодуль нужно подтянуть
      - name: Detect target submodule
        id: vars
        run: |
          # github.event.action равен строке вида "<path>-update"
          target="${{ github.event.action }}"
          target="${target%-update}"          # убираем суффикс "-update"
          echo "target=$target" >> "$GITHUB_OUTPUT"

      # Подтягиваем свежий коммит указанного субмодуля
      - name: Update ${{ steps.vars.outputs.target }}
        run: |
          git submodule update --remote --depth 1 "${{ steps.vars.outputs.target }}"
          git add "${{ steps.vars.outputs.target }}"

      # Коммитим и пушим изменения (если они есть)
      - name: Commit and push if there are changes
        run: |
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update ${{ steps.vars.outputs.target }} submodule to latest commit"
            git push
          fi
